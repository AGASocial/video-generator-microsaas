#!/usr/bin/env node

/**
 * Generate Theme Registry
 * 
 * This script scans the themes directory and automatically generates
 * the theme registry with all available themes.
 * 
 * Run with: node scripts/generate-theme-registry.js
 * Or it will run automatically before build (see package.json)
 */

const fs = require('fs');
const path = require('path');

const themesDir = path.join(__dirname, '..', 'themes');
const registryPath = path.join(themesDir, 'registry.ts');

// Get all directories in themes folder
function getThemeDirectories() {
  const items = fs.readdirSync(themesDir, { withFileTypes: true });
  const themeDirs = items
    .filter(item => item.isDirectory())
    .map(item => item.name)
    .filter(name => {
      // Check if the directory has an index.ts file (required for a theme)
      const indexPath = path.join(themesDir, name, 'index.ts');
      return fs.existsSync(indexPath);
    })
    .sort(); // Sort alphabetically for consistency

  return themeDirs;
}

// Generate the registry file content
function generateRegistryContent(themeNames) {
  const imports = themeNames.map(name => {
    // Import from the theme's index.ts file
    return `  ${name}: () => import('./${name}'),`;
  }).join('\n');

  return `/**
 * Theme Registry
 * Manages available themes and provides theme loading functionality
 * 
 * ‚ö†Ô∏è AUTO-GENERATED FILE - DO NOT EDIT MANUALLY
 * This file is generated by scripts/generate-theme-registry.js
 * To regenerate, run: npm run generate:themes
 */

import type { ThemeConfig } from './types'
import { defaultTheme } from './default'

// Registry of all available themes (auto-generated)
export const themeRegistry: Record<string, () => Promise<{ default: ThemeConfig }>> = {
${imports}
}

// Available theme names
export const availableThemes = Object.keys(themeRegistry)

/**
 * Get a theme by name
 */
export async function getTheme(themeName: string): Promise<ThemeConfig> {
  const themeLoader = themeRegistry[themeName]
  if (!themeLoader) {
    console.warn(\`Theme "\${themeName}" not found, falling back to default\`)
    return defaultTheme
  }
  
  try {
    const module = await themeLoader()
    return module.default
  } catch (error) {
    console.error(\`Failed to load theme "\${themeName}":\`, error)
    return defaultTheme
  }
}

/**
 * Get the default theme synchronously (for SSR)
 */
export function getDefaultTheme(): ThemeConfig {
  return defaultTheme
}
`;
}

// Main execution
function main() {
  try {
    console.log('üîç Scanning themes directory...');
    
    const themeNames = getThemeDirectories();
    
    if (themeNames.length === 0) {
      console.warn('‚ö†Ô∏è  No themes found! Make sure you have at least one theme folder with index.ts');
      return;
    }
    
    console.log(`‚úÖ Found ${themeNames.length} theme(s): ${themeNames.join(', ')}`);
    
    const content = generateRegistryContent(themeNames);
    
    fs.writeFileSync(registryPath, content, 'utf8');
    
    console.log(`‚ú® Successfully generated registry at ${registryPath}`);
  } catch (error) {
    console.error('‚ùå Error generating theme registry:', error);
    process.exit(1);
  }
}

main();

